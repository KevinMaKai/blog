# 前端 React 单元测试

## 前言

长期以来，前端开发的单元测试并不是在前端的开发过程中所必须的，也不是每个前端开发工程师所注意和重视的，
甚至扩大到软件开发过程中单元测试这一环也不是在章程上有书面规定所要求的。曾经的我也问过许多次自己以及身边的前端工程师。
为什么前端要写单元测试？前端的单元测试和测试工程师的测试有什么区别？在开发过程中，花费大量时间（甚至可能大于 50%）的之间去写单元测试值不值得？
这个问题我们后面再来回答

## 准备: 前端环境

常见环境部署方法，基本都是在 nodejs 官网下载 exe，msi 文件双击安装后直接可用。
nodejs 是一门更新很快的语言，我们常常要维护老项目，老项目依赖某个较早的 nodejs 版本，随便升级会生成莫名其妙的错误。
而 nodejs 的生态环境是总在不断向前推进的，很多工具，第三方包都在前进，舍弃旧环境。
很多时候如果环境不升级，我们需要手动安装很多老版本工具，而且连文档都查阅都会混乱，我们程序员也有需要保持最新的知识栈的需求。
此处推荐使用编程语言版本切换工具 🍀，nodejs 的就是[nvm](https://github.com/creationix/nvm)，
全称 Node Version Manager，官网有多系统安装方式。

## 第一部分: 函数式单元测试

说起单元测试，市面上的单元测试工具形形色色，五花八门。最常使用的工具为:Jest Mocha Jasmine

- 🛠 工具[Jest](https://www.npmjs.com/package/eslint)
  安装

  ```bash
  yarn add jest
  ```

  - facebook 坐庄
  - 基于 Jasmine 至今已经做了大量修改添加了很多特性
  - 开箱即用配置少，API 简单
  - 支持断言和仿真
  - 支持快照测试
  - 在隔离环境下测试
  - 互动模式选择要测试的模块
  - 优雅的测试覆盖率报告，基于 Istanbul
  - 智能并行测试(参考)
  - 较新，社区不十分成熟
  - 全局环境，比如 describe 不需要引入直接用
  - 较多用于 React 项目(但广泛支持各种项目)

- 🛠 工具[Mocha](https://mochajs.org/)
  安装

  ```bash
  yarn add mocha
  ```

  - 灵活(不包括断言和仿真，自己选对应工具)
  - 流行的选择：chai，sinon
  - 社区成熟用的人多，测试各种东西社区都有示例
  - 需要较多配置
  - 可以使用快照测试，但依然需要额外配置

个人推荐使用 jest 进行单元测试。理由如下：

- jest 与 babel 对 es6 的转码集成良好。
- jest 的 api 文档完整且 api 设计良好。
- jest 对异步代码测试内置支持完善。
- jest 内置完善的 mock 与 stub 工具。
- jest 运行如飞。
- jest 可自调用 istanbul，无痛生成覆盖率统计文档。
- jest 使用约定大于配置的原则，需配置项较少，且同时兼顾定制需求。
- 使用 jsdom，在 nodejs 环境可模拟浏览器环境，与 jest 集成后测试前端的浏览器环境代码。
- jest 文档丰富且有广泛的开发者基础。

### 函数式单元测试步骤

#### 测试前须知

1. 使用 Jest 进行单元测试必须保证函数式纯函数。即函数有入参并以 return 结尾。
2. 函数尽量不要依赖外部变量。
3. react 函数（返回值为 JSX）不输入该测试范围
4. jest 配置：在根目录下创建 jest.config.js 具体配置见 jest.config.js

#### 测试步骤

1. 写一个纯函数

```bash
  export default function(a){
    return a+2
  }
```

2. 在**test**文件夹下建一个文件 fn.test.js

3. 进行单元测试

```bash
import fn from 'util/fn'
describe('util/fn', () => {
  it('测试fn方法', () => {
    expect(fn(2)).toBe(4)
    expect(fn(3)).not.toBe(4)
  })
})
```

### 组件单元测试步骤

#### 测试前须知

1. 使用 Jest 进行组件测试需要模拟浏览器环境，目前与 react 配合较好的是 enzyme 及 jsdom。
2. 一个测试用例只做一件事，所以尽可能将组件拆分为最小单元。
3. 模拟数据及接口使用 fetch-mock
4. 在测试之前执行 steup 函数将所有环境模拟好，在测试中直接使用即可


### E2E单元测试步骤

#### 测试前须知